# 第二空間：走廊 - 完整邏輯與遊玩方式

## 📖 場景故事

### 場景描述

走廊像被拉長的冷白色傷口。兩側掛著破碎的鏡子，每一片都映出你不同的角度——但沒有一片完整地映出「你」。

燈光閃爍不是恐怖片那種誇張，而是更像**電壓不足**：這裡的恐怖是「省電」的。

你往前走，每一步都像踩在別人的影子上。

### 核心主題

- **權力階級**：便條揭示的職位等級制度
- **反射與真相**：鏡子反射揭示隱藏的線索
- **工具與觀察**：使用鏡片碎角看清模糊的標籤
- **秩序與混亂**：病床排列象徵權力結構

---

## 🎮 完整遊玩流程

### 階段一：探索與收集線索

#### 步驟 1：查看值班表（獲得關鍵線索）

**互動位置**：值班表（左側牆上，座標：`[-0.05, 0.3, 0.15, 0.5]`）

**操作方式**：
1. 點擊值班表 hotspot
2. 系統自動觸發 `read_duty_schedule` 事件

**獲得內容**：
- **道具**：`值班表背面的便條` (itemId: `note`)
- **關鍵線索**：職位等級制度
  ```
  主任 > 主治 > 住院 > 護理師 > 實習生
  ```

**對話顯示**：
> 獲得：值班表背面的便條
> 
> 用急促筆跡寫著：
> 「主任不會碰手術刀，主任只碰『同意書』。
> 主治負責執行，住院負責記錄，
> 護理師負責執行，實習生負責觀察。
> 
> 權力等級：主任 > 主治 > 住院 > 護理師 > 實習生」
> 
> 在這裡，階級不是制度，是刀口的方向。

**程式邏輯**：
```typescript
// 通過 engine.interactWithHotspot('duty_schedule') 觸發
// 事件系統檢查 hasInteracted('duty_schedule')
// 自動添加道具 note 到背包
```

**重要性**：⭐️⭐️⭐️⭐️⭐️  
這是解開病床排列謎題的關鍵線索。

---

#### 步驟 2：收集鏡片碎角（獲得工具）

**互動位置**：鏡片碎角（鏡子下方，座標：`[0.15, 0.85, 0.25, 0.95]`）

**操作方式**：
1. 點擊鏡片碎角 hotspot
2. 系統自動觸發 `pickup_mirror_shard` 事件

**獲得內容**：
- **道具**：`鏡片碎角` (itemId: `mirror_shard`)
- **用途**：用於反射光線，觀察模糊的標籤

**對話顯示**：
> 獲得：鏡片碎角
> 
> 它不鋒利，但足夠讓人誤以為自己還能反擊。

**程式邏輯**：
```typescript
// 通過 engine.interactWithHotspot('mirror_shard_spot') 觸發
// 事件系統檢查 hasInteracted('mirror_shard_spot')
// 自動添加道具 mirror_shard 到背包
```

**重要性**：⭐️⭐️⭐️⭐️  
這是觀察病床標籤的必需工具。

---

#### 步驟 3：觀察破碎的鏡子（提示線索）
**互動位置**：破碎的鏡子（左側牆上，座標：`[0.1, 0.2, 0.3, 0.6]`）
**操作方式**：
1. 點擊破碎的鏡子 hotspot
2. 顯示提示文字

**提示內容**：
> 它把你還給你，但先把你撕碎。

**程式邏輯**：
```typescript
// 特殊處理：直接顯示 hotspot.hint
// 增強沉浸感，暗示「反射」概念
```

**重要性**：⭐️⭐️  
暗示「反射」的概念，與密碼盤謎題相關。

---
### 階段二：使用工具揭示線索
#### 步驟 4：觀察病床（發現標籤）
**互動位置**：移動病床（走廊中央，座標：`[0.5, 0.5, 0.9, 0.8]`）

**操作方式**：
1. 點擊病床 hotspot
2. 系統檢查標籤是否已揭示

**第一次點擊（標籤未揭示）**：
- **情況 A：沒有鏡片碎角**
  > 每張病床上都有標籤，但字跡模糊不清。你需要工具才能看清上面的內容。
- **情況 B：有鏡片碎角**
  > 病床上的標籤很模糊，看不清楚。你手中的鏡片碎角或許可以反射光線，讓你看清標籤上的字。

**程式邏輯**：
```typescript
// 檢查 state.flags.beds_labels_revealed
// 如果未揭示：
//   - 檢查是否有 mirror_shard
//   - 顯示相應提示
//   - 記錄互動：engine.addInteraction('beds')
```

**重要性**：⭐️⭐️⭐️⭐️  
引導玩家使用道具。

---

#### 步驟 5：使用鏡片碎角觀察病床（揭示標籤）

**操作步驟**：
1. ✅ 已點擊病床（記錄互動）
2. ✅ 已收集鏡片碎角（在背包中）
3. 在背包中點擊「鏡片碎角」
4. 系統自動觸發 `use_mirror_shard_on_beds` 事件

**觸發條件**：
- ✅ `hasItem('mirror_shard')` - 已收集鏡片碎角
- ✅ `hasInteracted('beds')` - 已與病床互動

**獲得內容**：
- **標記**：`beds_labels_revealed = true`
- **揭示的標籤**：
  - 「主任」
  - 「主治」
  - 「住院」
  - 「護理師」
  - 「實習生」

**對話顯示**：
> 透過鏡片碎角的反射，你看到每張病床上都有模糊的標籤：
> 「主任」、「主治」、「住院」、「護理師」、「實習生」
> 這些標籤需要按照權力等級排列。便條上的線索突然有了意義。

**程式邏輯**：
```typescript
// 在 handleItemClick 中檢查：
//   - itemId === 'mirror_shard'
//   - scene.id === 'ch1_sc2'
//   - state.interactions.includes('beds')
// 觸發 engine.triggerEvent('use_mirror_shard_on_beds')
// 設置標記：beds_labels_revealed = true
```

**重要性**：⭐️⭐️⭐️⭐️⭐️  
這是解開病床排列謎題的前置條件。

---

### 階段三：解決謎題

#### 步驟 6：病床排列謎題（主要謎題）

**觸發條件**：
- ✅ 已揭示病床標籤（`beds_labels_revealed = true`）
- ✅ 已獲得便條（知道職位等級）

**操作方式**：
1. 點擊病床（在揭示標籤後）
2. 系統檢查標籤已揭示
3. 自動打開謎題輸入框

**謎題資訊**：
- **謎題ID**：`bed_arrangement`
- **類型**：序列輸入（sequence）
- **答案**：`['主任', '主治', '住院', '護理師', '實習生']`
- **輸入格式**：`主任,主治,住院,護理師,實習生`

**提示內容**：
> 按照職位高低排序。每張移動病床上的字母像屍體上的標籤。你把床推動時，輪子會發出像骨頭磨地的聲音。
> 
> 提示：便條上提到「主任只碰同意書」，這暗示了權力等級。
> 
> 輸入格式：主任,主治,住院,護理師,實習生

**解決後流程**：

1. **立即效果**：
   - 設置標記：`beds_arranged = true`
   - 顯示對話：
     > 排好後俯瞰，字母連成方向，像有人在空中替你指路。

2. **延遲 2 秒後**：
   - 播放廣播音效：`/audio/broadcast/broadcast_static.mp3`
   - 觸發劇烈閃爍效果
   - 觸發 `arrange_beds` 事件

3. **廣播事件觸發**：
   - 顯示廣播對話：
     > 07號，請保持心率在「漂亮」的範圍內。
   - 延遲 3 秒後顯示旁白：
     > 每張移動病床上的字母像屍體上的標籤。你把床推動時，輪子會發出像骨頭磨地的聲音。
     > 
     > 排好後俯瞰，字母連成方向，像有人在空中替你指路。
     > 
     > 有人安排你逃跑；更恐怖的是——你不知道他是救你，還是在放你出去「示範」。

4. **延遲 8 秒後**：
   - 切換場景到 `ch1_sc3`（第三空間：病房 702）

**程式邏輯**：
```typescript
// 在 handlePuzzleSolve 中：
// 1. engine.solvePuzzle() 設置 beds_arranged = true
// 2. 顯示謎題解決對話
// 3. 延遲 2 秒後：
//    - 播放廣播音效
//    - 觸發閃爍
//    - 觸發 arrange_beds 事件
// 4. 延遲 8 秒後切換場景
```

**重要性**：⭐️⭐️⭐️⭐️⭐️  
這是通關第二空間的關鍵謎題。

---

#### 步驟 7：鏡子反射密碼謎題（可選謎題）

**觸發條件**：無前置條件，隨時可解

**操作方式**：
1. 點擊密碼盤（右側牆上，座標：`[0.7, 0.2, 0.9, 0.4]`）
2. 自動打開謎題輸入框

**謎題資訊**：
- **謎題ID**：`mirror_password`
- **類型**：文字輸入（input）
- **答案**：`801`

**提示內容**：
> 你站到特定位置，從鏡子裡看到牆上的塗鴉不是亂寫，而像某人臨死前留下的數字。從鏡子裡看密碼盤是反的，但數字依然清晰。

**解決後效果**：
- 設置標記：`mirror_solved = true`
- 顯示對話（身世背景）：
  > 密碼盤解鎖的瞬間，你聽到一聲輕微的「喀」。
  > 
  > 從鏡子反射中，你看到牆上模糊的塗鴉突然清晰起來——那不是塗鴉，是血跡寫成的數字：801。
  > 
  > 你突然想起：那是你被帶走前的最後一個地址。801號房。你以為那是你的家，但現在你明白了——那只是你被「登記」的地方。
  > 
  > 你的名字不是名字，是編號。你的家不是家，是倉庫。

**重要性**：⭐️⭐️  
這是可選謎題，不影響通關，但提供額外的故事體驗。

---

## 🗺️ 完整流程圖

```
進入第二空間
    ↓
【探索階段 - 可並行進行】
1. 點擊值班表 → 觸發 read_duty_schedule → 獲得便條 ⭐️⭐️⭐️⭐️⭐️
2. 點擊鏡片碎角 → 觸發 pickup_mirror_shard → 收集道具 ⭐️⭐️⭐️⭐️
3. 點擊破碎的鏡子 → 顯示提示「反射」概念 ⭐️⭐️
    ↓
【工具使用階段】
4. 點擊病床 → 檢查標籤是否揭示
   - 未揭示 + 有鏡片碎角 → 提示使用道具 ⭐️⭐️⭐️⭐️
   - 未揭示 + 無鏡片碎角 → 提示需要工具 ⭐️⭐️⭐️⭐️
5. 使用鏡片碎角 → 觸發 use_mirror_shard_on_beds → 揭示標籤 ⭐️⭐️⭐️⭐️⭐️
    ↓
【解謎階段】
6. 點擊病床 → 觸發 bed_arrangement 謎題 ⭐️⭐️⭐️⭐️⭐️
   輸入：主任,主治,住院,護理師,實習生
   ↓
   解決謎題 → 設置 beds_arranged
   ↓
   延遲 2 秒 → 播放廣播 + 閃爍 → 觸發 arrange_beds 事件
   ↓
   顯示廣播對話 → 延遲 3 秒 → 顯示旁白對話
   ↓
   延遲 8 秒 → 切換到第三空間 ✅
   
【可選】
7. 點擊密碼盤 → 解決 mirror_password 謎題（REFLECT）⭐️⭐️
```

---

## 💡 解題技巧與提示

### 關鍵線索連接

1. **便條 + 病床標籤 = 排列順序**
   - 便條提供：職位等級制度（主任 > 主治 > 住院 > 護理師 > 實習生）
   - 病床標籤：五個職位名稱
   - 連接：按照等級排列

2. **鏡片碎角 + 病床 = 揭示標籤**
   - 鏡片碎角：反射工具
   - 病床：模糊的標籤
   - 連接：使用工具看清標籤

### 常見錯誤與解決

❌ **直接點擊病床想解謎題**
- **問題**：標籤還沒揭示，無法看到謎題
- **解決**：先使用鏡片碎角觀察病床

❌ **不知道職位等級順序**
- **問題**：便條線索沒仔細看
- **解決**：重新閱讀便條，記住「主任 > 主治 > 住院 > 護理師 > 實習生」

❌ **輸入格式錯誤**
- **問題**：沒有用逗號分隔
- **解決**：使用格式「主任,主治,住院,護理師,實習生」

❌ **忘記收集道具**
- **問題**：沒有鏡片碎角無法觀察病床
- **解決**：先收集所有可收集的道具

---

## 📝 道具與標記系統

### 可收集道具

| 道具ID | 道具名稱 | 獲得方式 | 用途 | 重要性 |
|--------|---------|---------|------|--------|
| `mirror_shard` | 鏡片碎角 | 點擊鏡片碎角 | 用於觀察病床標籤 | ⭐️⭐️⭐️⭐️ |
| `note` | 值班表背面的便條 | 點擊值班表 | 提供職位等級線索 | ⭐️⭐️⭐️⭐️⭐️ |

### 重要標記

| 標記ID | 觸發條件 | 用途 | 重要性 |
|--------|---------|------|--------|
| `beds_labels_revealed` | 使用鏡片碎角觀察病床 | 解鎖病床排列謎題 | ⭐️⭐️⭐️⭐️⭐️ |
| `beds_arranged` | 解決病床排列謎題 | 觸發 arrange_beds 事件和場景切換 | ⭐️⭐️⭐️⭐️⭐️ |
| `mirror_solved` | 解決鏡子反射謎題 | 可選，無實際用途 | ⭐️⭐️ |

---

## 🎬 劇情重點與恐怖元素

### 權力階級的恐怖

便條上的「主任只碰同意書」不只是職位描述，而是權力結構的體現：

- **主任**：最高權力，只負責簽字
- **主治**：執行者
- **住院**：記錄者
- **護理師**：執行者
- **實習生**：觀察者

這個等級制度不是醫療體系，而是**收割體系**。

### 反射與真相

鏡子反射的意象貫穿整個空間：
- **破碎的鏡子**：不完整的自我
- **密碼盤反射**：隱藏的真相
- **鏡片碎角**：看清真相的工具

### 被安排的逃亡

病床排列完成後，廣播響起：
> 07號，請保持心率在「漂亮」的範圍內。

這句話暗示：**你的逃亡可能也在他們的計劃之中**。

**恐怖點**：
- 他們連你恐懼時的生理反應都在欣賞
- 有人安排你逃跑；更恐怖的是——你不知道他是救你，還是在放你出去「示範」

---

## 🔧 程式碼架構

### 事件系統

所有互動都通過事件系統處理，確保邏輯清晰：

1. **pickup_mirror_shard**
   - 需求：`hasInteracted('mirror_shard_spot')`
   - 效果：添加道具 `mirror_shard`

2. **read_duty_schedule**
   - 需求：`hasInteracted('duty_schedule')`
   - 效果：添加道具 `note`

3. **read_note**
   - 需求：`hasItem('note')`
   - 效果：顯示便條內容（可重複觸發）

4. **use_mirror_shard_on_beds**
   - 需求：`hasItem('mirror_shard')` + `hasInteracted('beds')`
   - 效果：設置標記 `beds_labels_revealed = true`

5. **arrange_beds**
   - 需求：`beds_arranged === true`（謎題解決後自動滿足）
   - 效果：播放廣播 + 顯示旁白

### 謎題系統

1. **bed_arrangement**（主要謎題）
   - 類型：`sequence`
   - 答案：`['主任', '主治', '住院', '護理師', '實習生']`
   - 解決後：設置標記 + 觸發事件 + 切換場景

2. **mirror_password**（可選謎題）
   - 類型：`input`
   - 答案：`'REFLECT'`
   - 解決後：僅設置標記

### 互動邏輯

在 `page.tsx` 中的特殊處理：

1. **病床互動**：
   ```typescript
   // 檢查標籤是否揭示
   if (!state.flags.beds_labels_revealed) {
     // 顯示提示（根據是否有道具）
   } else {
     // 觸發謎題
   }
   ```

2. **道具使用**：
   ```typescript
   // 檢查場景和道具
   if (itemId === 'mirror_shard' && scene?.id === 'ch1_sc2') {
     // 檢查是否已與病床互動
     if (state.interactions.includes('beds')) {
       // 觸發觀察事件
     }
   }
   ```

3. **謎題解決後**：
   ```typescript
   // 病床排列謎題特殊處理
   if (currentPuzzle.id === 'bed_arrangement') {
     // 延遲觸發廣播事件
     // 播放音效和閃爍
     // 顯示廣播和旁白
     // 延遲切換場景
   }
   ```

---

## ✅ 通關檢查清單

- [ ] 獲得便條（職位等級線索）
- [ ] 收集鏡片碎角
- [ ] 點擊病床（記錄互動）
- [ ] 使用鏡片碎角觀察病床
- [ ] 解決病床排列謎題
- [ ] 觸發廣播事件
- [ ] 成功切換到第三空間

---

## 🎯 設計理念

### 邏輯鏈條

1. **線索收集** → 便條提供職位等級
2. **工具獲得** → 鏡片碎角用於觀察
3. **線索揭示** → 使用工具看清標籤
4. **謎題解決** → 結合線索排列病床
5. **劇情推進** → 觸發廣播，進入下一空間

### 玩家體驗

- **探索感**：自由探索，收集線索
- **工具感**：道具不是裝飾，有實際用途
- **邏輯感**：線索之間有明確關聯
- **成就感**：解決謎題後有明確反饋
- **恐怖感**：廣播和旁白營造緊張氛圍

### 音效與視覺效果

- **環境音**：持續播放醫院環境音
- **廣播音效**：病床排列完成後播放
- **閃爍效果**：廣播時觸發劇烈閃爍
- **對話節奏**：分階段顯示，確保玩家理解

---

## 📚 相關文件

- 場景定義：`data/gameData.ts` (ch1_sc2)
- 互動邏輯：`app/play/[chapterId]/[sceneId]/page.tsx`
- 故事設定：`.cursor/rules/story.mdc`

---

**最後更新**：2024年

